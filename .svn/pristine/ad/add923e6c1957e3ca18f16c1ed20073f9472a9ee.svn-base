<template>
  <div class="role">
    <Card>
      <Row slot="title"
           class="common-table-title">
        <Col span="12"
             class='title'>
        <CommonIcon :size='16'
                    :type='$route.meta.icon'></CommonIcon>
        {{$route.meta.title}}
        </Col>
        <Col span="12"
             class='action'>
        <Button type="info"
                size="small"
                icon="md-add"
                @click="formOpenModal()">添加</Button>
        <Button type="warning"
                size="small"
                icon="md-sync"
                @click="getData()">刷新</Button>
        </Col>
      </Row>
      <Row class="common-search-box"
           @keydown.enter.native="searchData">
        <Col span="24">
        <Input v-model="searchFields.displayName"
               placeholder="请输入角色名称" />
        <Button type="primary"
                icon="search"
                :loading="searchLoading"
                @click='searchData'>搜索</Button>
        </Col>
      </Row>
      <Table ref='table'
             :loading="tableLoading"
             :columns="tableFieldsRender"
             @on-selection-change='tableSelectionChange'
             :data="tableList"></Table>
      <Row>
        <Col span="12"
             class='common-footer-action'>
        <Poptip confirm
                title="是否批量删除?"
                @on-ok="deleteAllListData">
          <Button type="error"
                  icon="ios-trash">批量删除</Button>
        </Poptip>
        <Button icon="ios-download-outline"
                type="primary"
                @click="exportTableData"> 导出数据</Button>

        </Col>
        <Col span="12">
        <Page v-if='tableList.length>0'
              show-elevator
              :page-size="pageSize"
              :total="total"
              :current="curPage"
              @on-change="pageChange"
              @on-page-size-change='pageChangeSize'></Page>
        </Col>
      </Row>

      <Modal ref='formModal'
             v-model="formShow"
             :loading='modalButtonShowLoading'
             @on-ok='submitData'
             @on-cancel='formCloseModal'
             :title='$route.meta.title+"详情"'
             width='300'>
        <Spin fix
              v-if='formLoading'></Spin>
        <Form ref='form'
              :label-width="90"
              :model="formModel"
              :rules="formRule">
          <FormItem style='display:none'
                    label="名称："
                    prop="displayName">
            <Input v-model="formModel.displayName"
                   placeholder="请输入名称" />
          </FormItem>
          <FormItem label="角色名称："
                    style='width:250px;'
                    prop="name">
            <Input v-model="formModel.name"
                   @on-change='nameChange'
                   placeholder="请输入角色名称" />
          </FormItem>
          <FormItem label="角色权限："
                    prop="newRoleGroupId">
            <!-- <treeselect style='width:160px;'
                        placeholder='请选择角色权限'
                        noResultsText='没有数据'
                        :show-count="true"
                        v-model="formModel.newRoleGroupId"
                        :options="newRoleGroupList" /> -->
            <Select placeholder='请选择签到类型'
                    style='width:150px;'
                    clearable
                    v-model="formModel.newRoleGroupId">
              <Option v-for='(t,i) in newRoleGroupList'
                      :key='i'
                      :value="t.id">{{t.groupName}}</Option>
            </Select>
          </FormItem>
          <FormItem label="描述："
                    style='width:250px;'
                    prop="description">
            <Input v-model="formModel.description"
                   placeholder="请输入描述" />
          </FormItem>
          <FormItem label="状态："
                    prop="isStatic">
            <i-switch v-model="formModel.isStatic" />
          </FormItem>
          <FormItem style='display:none'
                    label="角色permissions："
                    prop="permissions">
            <!-- <Input v-model="formModel.access"
              placeholder="请输入access"/> -->
          </FormItem>
          <FormItem label="默认角色："
                    prop="isDefault ">
            <Checkbox @on-change='allowLateChange'
                      v-model="formModel.isDefault">是</Checkbox>
          </FormItem>
          <!-- <FormItem label="菜单管理："
                    prop="permissions">
            <treeselect placeholder='请选择菜单管理'
                        noResultsText='没有数据'
                        :show-count="true"
                        :multiple="true"
                        v-model="formModel.permissions"
                        :options="permissionsList" />
          </FormItem> -->

        </Form>
      </Modal>
    </Card>
    <tableMenu ref='tableMenu'
               @on-success='getData()'></tableMenu>
  </div>
</template>
<script>
import mixins from "@/libs/mixins.js";
import { mapMutations, mapActions } from 'vuex'
import { getRoleList, getnewRoleGroupList } from "@/api/data";
import tableMenu from "@/view/role/menu.vue";


export default {
  mixins: [mixins.commonPage],
  components: { tableMenu },
  name: 'roles',
  data () {
    return {
      newRoleGroupList: [],
      url: "/NewRoles",
      searchFields: {
        name: ""
      },
      tableFields: [
        {
          type: 'selection',
          width: 60,
          align: 'center'
        },
        {
          title: "角色名称",
          key: "name",
          align: "center"
        },
        {
          title: "角色权限",
          key: "groupName",
          align: "center"
        },
        {
          title: "角色描述",
          key: "description",
          align: "center"
        },
        {
          title: "角色状态",
          key: "isStatic",
          align: "center",
          render: (h, params) => {
            return h("span", params.row.isStatic ? '开启' : '关闭');
          }
        },
        // {
        //   title: "角色权限",
        //   key: "permissions",
        //   align: "center"
        // },
      ],
      formModel: {
        displayName: '',
        name: "",
        description: "",
        isStatic: false,
        permissions: [],
        newRoleGroupId: '',
      },
      formRule: {
        name: [{ required: true, message: "角色名称不能为空", }],
      },
      tableFieldsAction: {
        title: "操作",
        key: "action",
        width: 250,
        align: "center",
        render: (h, params) => {
          return h("div", [
            h(
              "Button", {
                props: {
                  icon: "ios-apps",
                  type: "info",
                  size: "small"
                },
                style: {
                  marginRight: "5px"
                },
                on: {
                  click: () => {
                    this.$refs['tableMenu'].formOpenModal(params.row.id);
                  }
                }
              },
              "菜单"
            ),
            h(
              "Button", {
                props: {
                  icon: "md-create",
                  type: "success",
                  size: "small"
                },
                style: {
                  marginRight: "5px"
                },
                on: {
                  click: () => {
                    this.formOpenModal(params.row[this.aliasId ? this.aliasId : 'id']);
                  }
                }
              },
              "修改"
            ),
            h(
              "Poptip", {
                props: {
                  confirm: true,
                  title: "您确定要删除这条数据吗?",
                  transfer: true
                },
                on: {
                  "on-ok": () => {
                    this.deleteData(params.row[this.aliasId ? this.aliasId : 'id']);
                  }
                }
              }, [
                h(
                  "Button", {
                    props: {
                      icon: "ios-trash",
                      type: "error",
                      size: "small"
                    }
                  },
                  "删除"
                )
              ]
            )
          ]);
        }
      },
    };
  },
  watch: {

  },
  computed: {

  },
  methods: {
    nameChange () {
      this.formModel.displayName = this.formModel.name;
    },
    //允许迟到选择框切换触发
    allowLateChange () {
      this.formModel.lateTime = 0;
    },
  },
  mounted () {
    getnewRoleGroupList().then((res) => {
      this.newRoleGroupList = res.data;
    })
  }
};
</script>
<style lang="less" scoped>
</style>
